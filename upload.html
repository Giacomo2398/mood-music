<!DOCTYPE>
<html>
    <html>
        <head>    
        <!--Import Google Icon Font-->
            <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <!-- GoogleFonts-->
            <link href="https://fonts.googleapis.com/css?family=Open+Sans:800" rel="stylesheet">
        <!-- Materialize CSS -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-alpha.2/css/materialize.min.css">
        <!--Let browser know website is optimized for mobile-->
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
            <link href="assets/css/style.css" rel="stylesheet">
        
            </head>
        <body onload="init();" id="upload-body"> <!--Must be loaded before js files!-->
            <!--Firebase-->
            <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
            <!-- import Jquery and Jquery UI before materialize-->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
            <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.0/jquery-ui.min.js"></script>
            <!--Materialize -->
                <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>

        <ul id="slide-out" class="sidenav">

            <li><a href="index.html" id="home">Home</a></li>
            <li><a href="upload.html" id="upload">Upload</a></li>
            <li><a href="favorites.html" id="favorites">Favorites</a></li>
            <li><a href="about.html" id="about">About</a></li>
            <li><a id="logout">Log out</a></li>

        </ul>
    
            <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
    
            <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>  

        <!--This contains code for the results window (right side of page)-->
        <div class="container" id="results">
           
            <div class="row">
                
                <div class="col md12" id="results-text">
                    MOOD + MUSIC
                </div>

            </div>

            <div class="row">

                <div class="col md12">
                    <p>This is where we tell you what you're feeling, and let you hear it!</p>
                </div>

            </div>

            <div class="row"> <!--Gif and Spotify playlist will be displayed here-->
                    <div id="gif">
                        <img id="mood-gif" alt="Mood Gif" src="">
                    </div>
               
            </div>

        </div>

        <!--This contains code for the image upload container, coded second because of the float-->
        <div class="container" id="upload-space">

            <div class="row">

                <div class="col md12" id="upload-text">
                    UPLOAD
                </div>

            </div>

            <div class="row">

                <div id="upload-slogan" class="col md12">
                    <p> 
                        Upload a photo below. If you'd like, use the camera, and then save the image to use as your upload.
                        When you're ready to get yourself a playlist click <a class="waves-effect waves-light btn-small" onclick="processImage();">ANALYZE</a>.
                    </p>
                </div>

            </div>

            <!-- This row contains the canvas for uploading the image. -->
            <div class="row">

                <div class="col md12">

                    <div id="webcamUpload">
                            <a id="startBtn" class="waves-effect waves-light btn-large" onclick="startWebcam();">Start Webcam</a>
                            <a id="snapBtn" class="waves-effect waves-light btn-large" onclick="snapshot();">Take Snapshot</a>
                    </div>

                    <div id="imgUpload">
                        <form action="#">
                                <div class="file-field input-field">
                                  <div class="btn">
                                    <span>File</span>
                                    <input type="file" type="file" accept="image" onchange="previewFile();">
                                  </div>
                                  <div class="file-path-wrapper">
                                    <input class="file-path validate" type="text">
                                  </div>
                                </div>
                        </form>
                    </div>

                    <div id="Media">
                        <video id="video" onclick="snapshot(this);" controls autoplay></video>
                        <canvas id="canvas"></canvas> 
                    </div>

                    <div id="selfie"> 
                    </div>

                    <div id="preview">
                        <img id="previewImg" src="" alt="Image Preview">  
                    </div> 
    
                </div> <!-- /container upload Space -->

            </div> <!--/ row -->
            

        </div> <!-- /container results-->
        <script type="text/javascript">

//--------------------
// GET USER MEDIA CODE
//--------------------
navigator.getUserMedia = ( navigator.getUserMedia ||
navigator.webkitGetUserMedia ||
navigator.mozGetUserMedia ||
navigator.msGetUserMedia);

var video;
var webcamStream;
var sourceImgUrl;

function startWebcam() {
    $("#preview").slideUp();
    $("#fileUp").val(null);
    $("#selfie").slideUp(); //hide selfie div to display video in its place
    $("#video").slideDown();
	if (navigator.getUserMedia) {
		navigator.getUserMedia ({
			video: true,
			audio: false
		},
		// successCallback
		function(localMediaStream) {
			video = document.querySelector('video');
            try {
                video.srcObject = localMediaStream;
            } catch (error) {
                video.src = URL.createObjectURL(localMediaStream);
            }
			webcamStream = localMediaStream;
		},
		// errorCallback
		function(err) {
			console.log("The following error occured: " + err);
		});
	} else {
		console.log("getUserMedia not supported");
	}  
}

//---------------------
// TAKE A SNAPSHOT CODE
//---------------------

var canvas, ctx;

function init() {
	// Get the canvas and obtain a context for
	// drawing in it
	canvas = document.getElementById("canvas");
	ctx = canvas.getContext('2d');
     $("#selfie").slideUp(5); 
     $("#preview").slideUp(5);
     $("#gif").fadeOut(5);
}

function snapshot() {     
    $("#selfieImg").remove(); //remove any previously displayed selfies
	ctx.drawImage(video, 0,0, canvas.width, canvas.height);
    var selfie = new Image();
    selfie.id = "selfieImg";
    selfie.src = canvas.toDataURL();  
    $("#selfie").html(selfie); 
    stopVideo();
    $("#video").slideUp(); 
    $("#selfie").slideDown(); 
}
 

function stopVideo() {
    if (webcamStream!= null) {
    webcamStream.getTracks().map(function (val) {
        val.stop(); }
        );
    }
}

//---------------------------
// IMAGE UPLOAD & PREVIEW CODE
//---------------------------
    function previewFile() {
     
  var preview = document.querySelector("#previewImg");
  var file    = document.querySelector("input[type=file]").files[0];
  var reader  = new FileReader();

  reader.addEventListener("load", function () {
    stopVideo();
    $("#video").slideUp();
    $("#selfie").slideUp();
    preview.src = reader.result;
    }, false);
    $("#preview").slideDown()
    if (file) {
        reader.readAsDataURL(file);
        sourceImgUrl = file;
        console.log(sourceImgUrl);
    }
}


//----------------------------------
// ANALZYE IMAGE AND DISPLAY RESULTS
//----------------------------------

function processImage() {
    var rapid = new RapidAPI("default-application_5b2ee88be4b08122a9a23ae4", "efb47cc8-30f0-4748-8471-3360632e9d86");
    var randomNum = Math.floor(Math.random()*20);
    var gifNum = randomNum.toString();

        rapid.call('KairosAPI', 'createEmotionalAnalysis', { 
        'appId': '856d4e0d',
        'source': sourceImgUrl,
        'appKey': '436faeac678d376364b610aa4c2822e7'

        }).on('success', function (payload) {
            M.toast({html: "Success!"});
            console.log(payload);
            console.log(payload.frames["0"].people["0"].emotions);

            let emotions = payload.frames["0"].people["0"].emotions;
            let strongestEmotion = "";
            let emotionScore = 0;
                for (var key in emotions) {
                if (emotions[key] > emotionScore) {
                    emotionScore = emotions[key];
                    strongestEmotion = key;
                    } else if (emotions[key] == emotionScore) {
                        strongestEmotion = "chill";
                    }
                };
                
                console.log(strongestEmotion);
                //put if statements for synonym array or thesaurus api call here. Set strongestEmotion to synonym to pass into giphy and spotify
        
        rapid.call('Giphy', 'searchGifs', { 
                        'query': strongestEmotion, 
                        'apiKey': 'dc6zaTOxFJmzC',
                        'limit': '20',
                    }).on('success', function (payload) {
                    // console.log(payload);
                    //console.log(payload.data); to test payload
                            var gifSrc = payload.data[gifNum].images.original.url;
                           $("#mood-gif").attr("src", gifSrc);
                           $("#gif").fadeIn(800);
                            console.log(payload.data);
                                        
                    }).on('error', function (payload) {
                        M.toast({html: "I'm sorry, there was an error fetching your GIF. That sucks huh? Maybe try again"});
                        console.log(payload);
                    });

        }).on('error', function (payload) {
            M.toast({html: "I'm sorry,  but that picture can't be analyzed. Please try another photo."});
            console.log(payload);
        }
            )
}
        </script>


        
<!-- Javascript File-->
<script src="assets/javascript/javascript.js"></script>
<!--Rapid API-->
<script src="assets/javascript/rapidapi.min.js"></script>
    </body>

</html>